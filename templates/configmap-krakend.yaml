{{- if .Values.krakend.enabled -}}
{{- $fullName := include "ConfiaPe.Loans.CD.fullname" . -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $fullName }}-krakend-config
  labels:
    {{- include "ConfiaPe.Loans.CD.labels" . | nindent 4 }}
    app.kubernetes.io/component: krakend
data:
  krakend.json: |
    {
      "$schema": "https://www.krakend.io/schema/krakend.json",
      "version": 3,
      "name": "{{ $fullName }}-gateway",
      "port": {{ .Values.krakend.service.port }},
      "timeout": "{{ .Values.krakend.config.timeout }}",
      "cache_ttl": "{{ .Values.krakend.config.cacheTTL }}",
      "output_encoding": "json",
      "extra_config": {
        {{- if .Values.krakend.config.cors.enabled }}
        "security/cors": {
          "allow_origins": {{ .Values.krakend.config.cors.allowOrigins | toJson }},
          "allow_methods": {{ .Values.krakend.config.cors.allowMethods | toJson }},
          "allow_headers": {{ .Values.krakend.config.cors.allowHeaders | toJson }},
          "expose_headers": {{ .Values.krakend.config.cors.exposeHeaders | toJson }},
          "max_age": "{{ .Values.krakend.config.cors.maxAge }}"
        },
        {{- end }}
        "router": {
          "return_error_msg": true
        }
      },
      "endpoints": [
        {{- $backendHost := printf "http://%s-backend:%d" $fullName (int .Values.backend.service.port) -}}
        {{- $frontendHost := printf "http://%s-frontend:%d" $fullName (int .Values.frontend.service.port) -}}
        {{- $first := true -}}
        {{- range $endpoint := .Values.krakend.config.endpoints }}
        {{- $host := "" -}}
        {{- if eq $endpoint.backend "backend" -}}
          {{- $host = $backendHost -}}
        {{- else if eq $endpoint.backend "frontend" -}}
          {{- $host = $frontendHost -}}
        {{- else -}}
          {{- $host = $endpoint.backendHost -}}
        {{- end -}}
        {{- if $endpoint.wildcard }}
        {{- /* Generate wildcard routes with 1 to N path segments */ -}}
        {{- $depth := $endpoint.wildcardDepth | default 6 -}}
        {{- $prefix := $endpoint.endpoint -}}
        {{- $urlPrefix := $endpoint.urlPattern | default $endpoint.endpoint -}}
        {{- $methods := list "GET" "POST" "PUT" "DELETE" "PATCH" -}}
        {{- range $i := until (int $depth) -}}
        {{- $segments := "" -}}
        {{- range $j := until (add1 $i | int) -}}
          {{- $segments = printf "%s/{p%d}" $segments $j -}}
        {{- end -}}
        {{- range $method := $methods -}}
        {{- if not $first }},{{ end }}
        {{- $first = false }}
        {
          "endpoint": "{{ $prefix }}{{ $segments }}",
          "method": "{{ $method }}",
          {{- if $endpoint.outputEncoding }}
          "output_encoding": "{{ $endpoint.outputEncoding }}",
          {{- end }}
          {{- if $endpoint.inputHeaders }}
          "input_headers": {{ $endpoint.inputHeaders | toJson }},
          {{- end }}
          {{- if $endpoint.inputQueryStrings }}
          "input_query_strings": {{ $endpoint.inputQueryStrings | toJson }},
          {{- end }}
          "backend": [
            {
              "host": ["{{ $host }}"],
              "url_pattern": "{{ $urlPrefix }}{{ $segments }}"
              {{- if $endpoint.backendEncoding }},
              "encoding": "{{ $endpoint.backendEncoding }}"
              {{- end }}
            }
          ]
        }
        {{- end }}
        {{- end }}
        {{- else }}
        {{- /* Regular endpoint without wildcard */ -}}
        {{- if not $first }},{{ end }}
        {{- $first = false }}
        {
          "endpoint": "{{ $endpoint.endpoint }}",
          {{- if $endpoint.method }}
          "method": "{{ $endpoint.method }}",
          {{- end }}
          {{- if $endpoint.outputEncoding }}
          "output_encoding": "{{ $endpoint.outputEncoding }}",
          {{- end }}
          {{- if $endpoint.inputHeaders }}
          "input_headers": {{ $endpoint.inputHeaders | toJson }},
          {{- end }}
          {{- if $endpoint.inputQueryStrings }}
          "input_query_strings": {{ $endpoint.inputQueryStrings | toJson }},
          {{- end }}
          "backend": [
            {
              "host": ["{{ $host }}"],
              "url_pattern": "{{ $endpoint.urlPattern | default $endpoint.endpoint }}"
              {{- if $endpoint.backendEncoding }},
              "encoding": "{{ $endpoint.backendEncoding }}"
              {{- end }}
            }
          ]
        }
        {{- end }}
        {{- end }}
      ]
    }
{{- end }}
